{% extends "polizas/cliente/layout.html" %}
{% load reclamo_extras %}  {# Cargar el filtro de colores #}

{% block title %}Reclamo {{ reclamo.codigo }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Columna principal -->
  <div class="lg:col-span-2 space-y-4">
    <div class="bg-white p-6 rounded shadow">
      <div class="flex justify-between items-start">
        <div>
          <h2 class="text-xl font-semibold">{{ reclamo.motivo|default:"(Sin motivo)" }}</h2>
          <p class="text-sm text-gray-500">#{{ reclamo.codigo }} • {{ reclamo.fecha|date:"d/m/Y H:i" }}</p>
        </div>

        <div class="text-right">
          <span class="px-3 py-1 text-xs rounded text-white {{ reclamo.estado|estado_color }}">
            {{ reclamo.get_estado_display }}
          </span>
          <p class="text-xs text-gray-400 mt-1">Prioridad: {{ reclamo.get_prioridad_display }}</p>
        </div>
      </div>

      <hr class="my-4" />

      <div class="prose max-w-none text-sm text-gray-700">
        {{ reclamo.descripcion|linebreaksbr }}
      </div>

      {% if reclamo.evidencia %}
        <div class="mt-4">
          <a href="{{ reclamo.evidencia.url }}" target="_blank" class="text-sky-600 underline">Ver evidencia</a>
        </div>
      {% endif %}
    </div>

    <!-- Historial -->
    <div id="historial" class="bg-white p-4 rounded shadow">
      <h3 class="font-semibold mb-3">Historial</h3>
      {% include "reclamos/partials/_historial.html" with historial=reclamo.historial.all %}
    </div>
  </div>

  <!-- Columna derecha: acciones -->
  <aside class="space-y-4">
    <!-- Subir evidencia -->
    <div class="bg-white p-4 rounded shadow">
      <h4 class="font-semibold mb-2">Subir evidencia</h4>

      <form id="form-evidencia" method="post" enctype="multipart/form-data"
            hx-post="{% url 'reclamos:subir_evidencia' reclamo.pk %}"
            hx-include="#form-evidencia"
            hx-target="#mensaje-evidencia"
            hx-swap="innerHTML">
        {% csrf_token %}
        {{ evidencia_form.evidencia }}
        <div class="mt-3 flex gap-2">
          <button class="px-3 py-1 rounded bg-sky-600 text-white text-sm">Subir</button>
          <a href="#" class="text-sm text-gray-500">Instrucciones</a>
        </div>
      </form>

      <div id="mensaje-evidencia" class="mt-3 text-sm text-gray-600"></div>
    </div>

    <!-- Cambiar estado (solo staff/agent) -->
    {% if user.is_staff or (user.perfil and user.perfil.rol == "agent") %}
      <div class="bg-white p-4 rounded shadow">
        <h4 class="font-semibold mb-2">Cambiar estado</h4>

        <form id="form-estado"
              hx-post="{% url 'reclamos:cambiar_estado' reclamo.pk %}"
              hx-target="#mensaje-estado"
              hx-swap="innerHTML">
          {% csrf_token %}
          <label class="block text-sm">Nuevo estado</label>
          <select name="nuevo_estado" class="form-select mt-1 w-full">
            {% for code,label in reclamo._meta.get_field('estado').choices %}
              <option value="{{ code }}">{{ label }}</option>
            {% endfor %}
          </select>

          <label class="block text-sm mt-2">Nota (opcional)</label>
          <textarea name="nota" rows="3" class="form-textarea mt-1 w-full"></textarea>

          <div class="mt-3 flex justify-between">
            <button class="px-3 py-1 rounded bg-green-600 text-white text-sm">Guardar</button>
            <a href="{% url 'reclamos:mis_reclamos' %}" class="text-sm text-gray-500">Volver</a>
          </div>
        </form>

        <div id="mensaje-estado" class="mt-2 text-sm text-gray-600"></div>
      </div>
    {% endif %}

    <!-- Datos rápidos -->
    <div class="bg-white p-4 rounded shadow text-sm">
      <p><strong>Póliza:</strong> {{ reclamo.poliza.poliza_numero }}</p>
      <p><strong>Asignado a:</strong> {{ reclamo.asignado_a.username if reclamo.asignado_a else "Sin asignar" }}</p>
      <p><strong>Última actualización:</strong> {{ reclamo.actualizado|date:"d/m/Y H:i" }}</p>
    </div>
  </aside>
</div>
{% endblock %}
